<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Param√®tres Sub Goal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #181818;
      color: #ffd75e;
      padding: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h2 {
      margin-top: 0;
    }

    form {
      width: 100%;
      max-width: 550px;
      background: #232323;
      padding: 1.5em;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0006;
      margin-bottom: 1em;
    }

    .level,
    .conversion {
      background: #2e2e2e;
      margin-bottom: 10px;
      padding: 0.8em;
      border-radius: 6px;
    }

    label {
      display: block;
      margin-bottom: 0.3em;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.4em;
      border-radius: 5px;
      border: none;
      margin-bottom: 0.6em;
      background: #333;
      color: #ffd75e;
    }

    button {
      padding: 0.6em 1em;
      border: none;
      border-radius: 5px;
      background: #ffd75e;
      color: #232323;
      font-weight: bold;
      cursor: pointer;
      margin: 0.3em;
      transition: background 0.2s;
      width: calc(100% - 0.6em);
    }

    button:hover {
      background: #ffe28a;
    }

    button.deleteBtn {
      background: #d32f2f;
      color: white;
      margin-top: 0.5em;
    }

    button.deleteBtn:hover {
      background: #f44336;
    }

    button.secondary {
      background: #4a90e2;
      color: white;
    }

    button.secondary:hover {
      background: #6aa8f5;
    }

    button.warning {
      background: #ff9800;
      color: white;
    }

    button.warning:hover {
      background: #ffa726;
    }

    #current-status {
      width: 100%;
      max-width: 550px;
      background: #232323;
      padding: 1.5em;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0006;
      margin-bottom: 1em;
      display: none;
    }

    #current-status h4 {
      margin-top: 0;
      color: #ffd75e;
    }

    #current-status p {
      margin: 0.5em 0;
      color: #fff;
    }

    #current-status span {
      color: #ffd75e;
      font-weight: bold;
    }

    #preview-container {
      width: 100%;
      max-width: 550px;
      margin-top: 10px;
    }

    #preview-bar {
      width: 100%;
      height: 25px;
      background-color: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    #preview-pulse-wrapper {
      position: absolute;
      inset: 0;
      animation: pulse 2s linear infinite alternate;
    }

    #preview-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 50%;
      border-radius: 10px;
      background: linear-gradient(90deg, #ad7d22 0%, #ffb74a 100%);
      z-index: 2;
    }

    #preview-wave1,
    #preview-wave2 {
      position: absolute;
      inset: 0;
      z-index: 1;
      width: 40px;
      height: 50px;
      left: 50%;
      background: #ffb74a;
      border-radius: 50%;
      animation: wave 0.5s ease-in-out infinite alternate;
      transition: ease left 0.5s;
    }

    #preview-wave1 {
      top: -60%;
    }

    #preview-wave2 {
      top: -10%;
      animation-delay: -80ms;
    }

    @keyframes wave {
      0% {
        transform: translateX(-80%);
      }

      100% {
        transform: translateX(-60%);
      }
    }

    @keyframes pulse {
      0% {
        filter: brightness(90%);
      }

      100% {
        filter: brightness(120%);
      }
    }

    #msg {
      margin-top: 0.5em;
      padding: 1em;
      border-radius: 5px;
      display: none;
    }

    #msg.success {
      background: #4caf50;
      color: white;
      display: block;
    }

    #msg.error {
      background: #f44336;
      color: white;
      display: block;
    }

    #msg.warning {
      background: #ff9800;
      color: white;
      display: block;
    }
  </style>
</head>

<body>

  <h2>Configurer le Sub/Donation Goal</h2>

  <!-- √âtat actuel -->
  <div id="current-status">
    <h4>üìä √âtat actuel de l'overlay :</h4>
    <p>Points actuels : <span id="statusPoints">0</span> pts</p>
    <p>Niveau actuel : <span id="statusLevel">0</span></p>
    <p>Palier en cours : <span id="statusLevelName">-</span></p>
  </div>

  <form id="settingsForm">
    <h3>Texte une fois le goal final atteint</h3>
    <div class="conversion">
      <label>Titre final affich√© :
        <input type="text" id="finalTitleInput" placeholder="Ex : Merci pour la thune !">
      </label>
    </div>

    <h3>Paliers</h3>
    <div id="levels-container"></div>
    <button type="button" id="addLevel">+ Ajouter un palier</button>

    <h3>Points par action</h3>
    <div class="conversion">
      <label>100 bits = <input type="number" id="bitsInput" min="0" step="0.1" value="1"> points</label>
      <label>1 sub = <input type="number" id="subsInput" min="0" step="0.1" value="2"> points</label>
      <label>1‚Ç¨ de don = <input type="number" id="donInput" min="0" step="0.1" value="1"> points</label>
    </div>

    <h3>Points de d√©part (pour r√©initialisation)</h3>
    <div class="conversion">
      <label>Points de d√©part :
        <input type="number" id="startPointsInput" min="0" step="0.01" value="0" placeholder="Ex: 50.00">
      </label>
    </div>

    <h3>Options d'affichage</h3>
    <div class="conversion">
      <label>
        <input type="checkbox" id="hideWavesInput">
        Cacher les animations de vagues
      </label>
    </div>

    <h3>Couleurs du d√©grad√©</h3>
    <div class="conversion">
      <label>Couleur 1 (d√©but) :
        <input type="color" id="gradientColor1Input" value="#ad7d22">
      </label>
      <label>Couleur 2 (fin / waves) :
        <input type="color" id="gradientColor2Input" value="#ffb74a">
      </label>
    </div>

    <h3>Actions</h3>
    <div class="conversion">
      <button type="button" id="loadCurrentBtn" class="secondary">üì• Charger les valeurs actuelles</button>
      <button type="submit">‚úÖ Appliquer la configuration</button>
      <button type="button" id="resetProgressBtn" class="warning">üîÑ R√©initialiser la progression</button>
    </div>
  </form>

  <div id="msg"></div>

  <h3>Aper√ßu (50%)</h3>
  <div id="preview-container">
    <div id="preview-bar">
      <div id="preview-pulse-wrapper">
        <div id="preview-wave1"></div>
        <div id="preview-wave2"></div>
        <div id="preview-fill"></div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      CURRENT_POINTS: 'subGoal_currentPoints',
      CURRENT_LEVEL: 'subGoal_currentLevel',
      LEVELS: 'subGoal_levels',
      POINTS_CONFIG: 'subGoal_pointsConfig',
      GRADIENT: 'subGoal_gradient',
      OPTIONS: 'subGoal_options',
      FINAL_TITLE: 'subGoal_finalTitle'
    };

    const levelsContainer = document.getElementById("levels-container");
    const addButton = document.getElementById("addLevel");
    const msgEl = document.getElementById("msg");

    const gradientColor1Input = document.getElementById("gradientColor1Input");
    const gradientColor2Input = document.getElementById("gradientColor2Input");
    const hideWavesInput = document.getElementById("hideWavesInput");
    const finalTitleInput = document.getElementById("finalTitleInput");

    const previewFill = document.getElementById("preview-fill");
    const previewWave1 = document.getElementById("preview-wave1");
    const previewWave2 = document.getElementById("preview-wave2");

    function showMessage(text, type = 'success') {
      msgEl.textContent = text;
      msgEl.className = type;
      setTimeout(() => {
        msgEl.style.display = 'none';
        msgEl.className = '';
      }, 5000);
    }

    function updatePreview() {
      const c1 = gradientColor1Input.value || "#ad7d22";
      const c2 = gradientColor2Input.value || "#ffb74a";

      previewFill.style.background = `linear-gradient(90deg, ${c1} 0%, ${c2} 100%)`;
      previewWave1.style.backgroundColor = c2;
      previewWave2.style.backgroundColor = c2;

      const hide = hideWavesInput.checked;
      previewWave1.style.display = hide ? "none" : "block";
      previewWave2.style.display = hide ? "none" : "block";
    }

    gradientColor1Input.addEventListener("input", updatePreview);
    gradientColor2Input.addEventListener("input", updatePreview);
    hideWavesInput.addEventListener("change", updatePreview);

    updatePreview();

    let levels = [
      { name: "Palier 1 : D√©collage", target: 100 },
      { name: "Palier 2 : Propulsion", target: 300 }
    ];

    function renderLevels() {
      levelsContainer.innerHTML = "";
      levels.forEach((lvl, i) => {
        const div = document.createElement("div");
        div.className = "level";
        div.innerHTML = `
          <label>Nom du palier ${i + 1}:
            <input type="text" data-index="${i}" data-field="name" value="${lvl.name}">
          </label>
          <label>Objectif (points):
            <input type="number" data-index="${i}" data-field="target" min="1" value="${lvl.target}">
          </label>
          <button type="button" class="deleteBtn" data-index="${i}">üóëÔ∏è Supprimer ce palier</button>
        `;
        levelsContainer.appendChild(div);
      });
    }

    addButton.onclick = () => {
      levels.push({ name: "Nouveau palier", target: 100 });
      renderLevels();
    };

    levelsContainer.addEventListener("input", (e) => {
      const i = e.target.dataset.index;
      const field = e.target.dataset.field;
      if (field === "target") {
        levels[i][field] = parseFloat(e.target.value) || 0;
      } else {
        levels[i][field] = e.target.value;
      }
    });

    levelsContainer.addEventListener("click", (e) => {
      if (e.target.classList.contains("deleteBtn")) {
        const index = parseInt(e.target.dataset.index);
        if (levels.length > 1) {
          levels.splice(index, 1);
          renderLevels();
        } else {
          alert("‚ö†Ô∏è Vous devez garder au moins 1 palier !");
        }
      }
    });

    // Charger les valeurs actuelles
    document.getElementById("loadCurrentBtn").onclick = () => {
      try {
        const currentPoints = parseFloat(localStorage.getItem(STORAGE_KEYS.CURRENT_POINTS)) || 0;
        const currentLevel = parseInt(localStorage.getItem(STORAGE_KEYS.CURRENT_LEVEL)) || 0;

        document.getElementById("statusPoints").textContent = currentPoints.toFixed(2);
        document.getElementById("statusLevel").textContent = currentLevel;

        // Charger la config existante
        const savedLevels = localStorage.getItem(STORAGE_KEYS.LEVELS);
        if (savedLevels) {
          levels = JSON.parse(savedLevels);
          renderLevels();
          
          // Afficher le nom du palier en cours
          if (currentLevel < levels.length) {
            document.getElementById("statusLevelName").textContent = levels[currentLevel].name;
          } else {
            document.getElementById("statusLevelName").textContent = "Tous les paliers atteints !";
          }
        }

        const savedPoints = localStorage.getItem(STORAGE_KEYS.POINTS_CONFIG);
        if (savedPoints) {
          const pts = JSON.parse(savedPoints);
          document.getElementById("bitsInput").value = pts.bits;
          document.getElementById("subsInput").value = pts.sub;
          document.getElementById("donInput").value = pts.donation;
        }

        const savedGradient = localStorage.getItem(STORAGE_KEYS.GRADIENT);
        if (savedGradient) {
          const grad = JSON.parse(savedGradient);
          gradientColor1Input.value = grad.c1;
          gradientColor2Input.value = grad.c2;
          updatePreview();
        }

        const savedOptions = localStorage.getItem(STORAGE_KEYS.OPTIONS);
        if (savedOptions) {
          const opts = JSON.parse(savedOptions);
          hideWavesInput.checked = opts.hideWaves;
          updatePreview();
        }

        const savedFinalTitle = localStorage.getItem(STORAGE_KEYS.FINAL_TITLE);
        if (savedFinalTitle) {
          finalTitleInput.value = savedFinalTitle;
        }

        document.getElementById("current-status").style.display = "block";
        showMessage("‚úÖ Valeurs actuelles charg√©es !", "success");
      } catch (e) {
        showMessage("‚ùå Erreur lors du chargement", "error");
        console.error(e);
      }
    };

    // Appliquer la configuration
    document.getElementById("settingsForm").onsubmit = (e) => {
      e.preventDefault();

      // Validation des paliers
      for (let i = 1; i < levels.length; i++) {
        if (levels[i].target < levels[i - 1].target) {
          showMessage(`‚ö†Ô∏è Erreur : Palier ${i + 1} (${levels[i].target}) doit √™tre >= Palier ${i} (${levels[i - 1].target})`, "error");
          return;
        }
      }

      try {
        // Sauvegarder les paliers
        localStorage.setItem(STORAGE_KEYS.LEVELS, JSON.stringify(levels));

        // Sauvegarder la config des points
        const points = {
          bits: parseFloat(document.getElementById("bitsInput").value),
          sub: parseFloat(document.getElementById("subsInput").value),
          donation: parseFloat(document.getElementById("donInput").value)
        };
        localStorage.setItem(STORAGE_KEYS.POINTS_CONFIG, JSON.stringify(points));

        // Sauvegarder le gradient
        const gradient = {
          c1: gradientColor1Input.value,
          c2: gradientColor2Input.value
        };
        localStorage.setItem(STORAGE_KEYS.GRADIENT, JSON.stringify(gradient));

        // Sauvegarder les options
        const options = {
          hideWaves: hideWavesInput.checked
        };
        localStorage.setItem(STORAGE_KEYS.OPTIONS, JSON.stringify(options));

        // Sauvegarder le titre final
        localStorage.setItem(STORAGE_KEYS.FINAL_TITLE, finalTitleInput.value || "");

        showMessage("‚úÖ Configuration appliqu√©e ! L'overlay se mettra √† jour automatiquement.", "success");
      } catch (e) {
        showMessage("‚ùå Erreur lors de la sauvegarde", "error");
        console.error(e);
      }
    };

    // R√©initialiser la progression
    document.getElementById("resetProgressBtn").onclick = () => {
      if (confirm("‚ö†Ô∏è R√©initialiser les points √† la valeur de d√©part ?")) {
        const startPoints = parseFloat(document.getElementById("startPointsInput").value) || 0;

        localStorage.setItem(STORAGE_KEYS.CURRENT_POINTS, startPoints);
        localStorage.setItem(STORAGE_KEYS.CURRENT_LEVEL, 0);

        showMessage(`üîÑ Progression r√©initialis√©e √† ${startPoints} points !`, "warning");

        // Rafra√Æchir l'affichage
        document.getElementById("loadCurrentBtn").click();
      }
    };

    renderLevels();
  </script>
</body>

</html>
